# HubbleNego Hubble連携利用 仕様書

> HubbleユーザーがNegoを使って契約交渉を行う場合のユーザーフローと画面仕様を定義します。
> 共通仕様（AI機能、バージョン管理、署名・締結フロー、交渉詳細画面等）は [PRD_Common.md](./PRD_Common.md) を参照してください。

---

## 1. 概要

### 1.1 このパターンの対象ユーザー
- 既存のHubbleユーザー
- 社内で契約書を管理しつつ、取引先との交渉にNegoを使いたいユーザー
- 社内コメントと交渉コメントを分けて管理したいユーザー

### 1.2 主な特徴
- **Hubbleが契約書の「マスター」** - バージョン管理の中心はHubble
- **Negoは「交渉レイヤー」** - 社外との交渉専用画面
- **コメントの分離** - 社内コメント（Hubble）と交渉コメント（Nego）が明確に分かれる
- **双方向同期** - HubbleとNegoでバージョンが自動同期

### 1.3 Nego単体利用との違い

| 項目 | Nego単体利用 | Hubble連携利用 |
|------|-------------|----------------|
| 契約書のマスター | Nego | Hubble |
| アップロード場所 | Negoに直接 | Hubble経由 |
| 社内コメント | なし（全員に見える） | Hubble側で管理（社外に見えない） |
| バージョン管理 | Nego内で完結 | Hubbleと同期 |
| 入口画面 | Negoダッシュボード | Hubbleの契約書画面 |

---

## 2. ユーザーフロー

### 2.1 Hubble側ユーザー（契約書オーナー）のフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  [Hubbleで契約書作成]                                            │
│        │                                                         │
│        ↓                                                         │
│  [1. 交渉相手に共有]  →  [2. 招待]  →  [3. 交渉開始]            │
│        │                     │              │                    │
│        ↓                     ↓              ↓                    │
│   ツールバーの          メールor       Hubble内で状況確認        │
│   「交渉相手に共有」     リンクで招待   Nego画面で交渉            │
│   ボタンをクリック                                               │
│                                              │                   │
│                                              ↓                   │
│                               [4. 修正版受信] → [5. 署名・締結]   │
│                                    │               │             │
│                                    ↓               ↓             │
│                              Hubbleに自動反映  全員署名完了で     │
│                              新バージョン作成  契約締結           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 招待された側（交渉相手）のフロー

```
招待リンクを受信 → 契約書プレビュー確認 → サインイン → Negoで交渉に参加
                     (AI概要表示)      (Google/Microsoft)
```

※招待された側は通常のNego画面を使用（Hubbleを使わない）

---

## 3. 画面構成

### 3.1 画面一覧

| 画面名 | 説明 | ファイル |
|--------|------|---------|
| Hubble契約書画面（初回共有） | 交渉開始前のHubble画面 | hubble-ui-first-share.html |
| Hubble契約書画面（交渉中） | 交渉中のHubble画面 | hubble-ui.html |
| Nego交渉画面 | 交渉相手とのやり取り画面 | negotiation.html |

### 3.2 画面遷移図

```
[Hubble契約書画面（初回共有）]
         │
         │ 「交渉相手に共有」クリック
         ↓
     [招待モーダル]
         │
         │ 招待送信
         ↓
[Hubble契約書画面（交渉中）]  ←→  [Nego交渉画面]
         │                              │
         │ 「Negoを開く」               │
         └──────────────────────────────┘
```

---

## 4. Hubble契約書画面（初回共有前）

交渉を開始する前のHubble画面。

### 4.1 画面レイアウト

```
┌─────────────────────────────────────────────────────────────────┐
│ Hubble    ドキュメント > シリーズB > 株主間契約書               │
├─────────────────────────────────────────────────────────────────┤
│ [更新] [DL] [UP] [印刷] │ [表示] [検索]   [交渉相手に共有] [Word編集]│
├─────────┬───────────────────────────────────────────┬───────────┤
│ Ver.    │                                           │ コメント  │
│         │                                           │           │
│ [3] ◉  │         契約書本文エリア                  │ 社内の    │
│  1/28   │                                           │ コメント  │
│ [2]     │                                           │ のみ表示  │
│  1/27   │                                           │           │
│ [1]     │                                           │           │
│  1/25   │                                           │           │
│         │                                           │           │
└─────────┴───────────────────────────────────────────┴───────────┘
```

### 4.2 ポイント
- **交渉バナーなし** - まだ交渉が始まっていない
- **ツールバーに「交渉相手に共有」ボタン** - オレンジのアウトラインスタイル
- **コメントは社内のみ** - 交渉コメントはまだない

---

## 5. 招待モーダル

「交渉相手に共有」ボタンクリックで表示。

### 5.1 モーダルレイアウト

```
┌─────────────────────────────────────────────────────────────────┐
│  👥 交渉相手を招待                                        [×]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ──── 共有するバージョン ────                                    │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ 📄 株主間契約書                        Ver.3（最新）   │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ℹ️ 招待された方は、契約書の閲覧・編集・コメントが              │
│     できます。署名者は署名手続き・設定で別途指定します。        │
│                                                                  │
│  ──── メールアドレスで招待 ────                                  │
│  [ tanaka@example.com              ] [+]                         │
│                                                                  │
│  ──── または ────                                                │
│  🔗 招待リンクをコピー                                           │
│  [ https://nego.app/join/x7k2mP... ] [コピー]                    │
│  💡 招待された方は契約書を閲覧できます。                         │
│     編集・合意にはサインインが必要です。                         │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                              [キャンセル] [交渉を開始]          │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 仕様
- 共有するバージョンを明示（現在選択中のバージョン）
- 招待された人ができること（閲覧・編集・コメント）を説明文として表示（権限選択UIは設けない）
- 署名者は署名手続き・設定で別途指定する旨を明記
- メールアドレス入力 + 招待リンクの2つの招待方法
- **メールアドレスは任意** — 未入力でも交渉を開始できる（リンク共有のみでの招待を想定）
- ボタンラベルはメールアドレスの有無で動的に変化：
  - メール未入力時：「交渉を開始」
  - メール入力済み：「招待して交渉を開始」

---

## 6. Hubble契約書画面（交渉中）

交渉開始後のHubble画面。上部にバナーが表示される。

### 6.1 画面レイアウト

```
┌─────────────────────────────────────────────────────────────────┐
│ 🟠 交渉中 ｜ Ver.4を共有中                      [Negoを開く →] │
├─────────────────────────────────────────────────────────────────┤
│ Hubble    ドキュメント > シリーズB > 株主間契約書               │
├─────────────────────────────────────────────────────────────────┤
│ [更新] [DL] [UP] [印刷] │ [表示] [検索]   [交渉相手に共有] [Word編集]│
├─────────┬───────────────────────────────────────────┬───────────┤
│ Ver.    │                                           │ コメント  │
│         │                                           │           │
│ [5]     │         契約書本文エリア                  │ 社内 +    │
│  🔶→    │                                           │ 交渉      │
│ [4] ◉  │                                           │ コメント  │
│  🔵←    │                                           │ 表示      │
│ [3]     │                                           │           │
│  🔵→    │                                           │           │
│         │                                           │           │
└─────────┴───────────────────────────────────────────┴───────────┘
```

### 6.2 交渉バナー

ページ最上部（ヘッダーの上）に表示されるオレンジ色のバナー。

| 要素 | 説明 |
|------|------|
| アイコン | 🟠（オレンジ丸） |
| ステータス | 「交渉中」「返答待ち」「署名中」「締結済み」など |
| 共有バージョン | 「Ver.4を共有中」 |
| アクション | 「Negoを開く →」リンク |

### 6.3 バージョンリストの表示

交渉に関わるバージョンにはアイコンを表示。

| アイコン | 意味 |
|---------|------|
| 🔵→ | 自分が相手に共有したバージョン |
| 🔶← | 相手から受け取ったバージョン |
| （なし） | 交渉に関係ないバージョン（社内のみ） |

### 6.4 コメントの表示

| コメントタイプ | スタイル | 説明 |
|---------------|---------|------|
| 社内コメント | 背景なし、線なし | Hubble内の社内向けコメント |
| 交渉コメント | オレンジ左線 + オレンジ背景 | Negoでの交渉相手とのコメント |

```
┌─────────────────────────────────────┐
│ 田中（法務） 1/28 11:30             │   ← 社内コメント（装飾なし）
│ レビュー完了しました。              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ ▌山田（相手先） 1/28 14:00  via Nego│   ← 交渉コメント（オレンジ線+背景）
│ ▌第3条について確認させてください。  │
│ ▌                                   │
│ ▌        [Negoで返信する]           │
└─────────────────────────────────────┘
```

---

## 7. Hubble↔Nego間のバージョン同期

### 7.1 設計思想：同期の方向性

Hubbleは社内の安全な編集環境であり、社内向けに作成中のバージョンが意図せず交渉相手に共有されてはならない。
この原則に基づき、同期の方向によって挙動が異なる。

| 方向 | 挙動 | 理由 |
|------|------|------|
| **Nego → Hubble** | 自動同期 | 交渉相手の修正は社内で即座に把握すべき |
| **Hubble → Nego** | 手動共有（「交渉相手に共有」ボタン） | 社内での編集途中の内容が交渉相手に漏れるのを防ぐ |

コメントも同じ考え方：
| 方向 | 挙動 | 理由 |
|------|------|------|
| **Negoの交渉コメント → Hubble** | 表示される | 交渉の状況を社内で把握するため |
| **Hubbleの社内コメント → Nego** | 表示されない | 社内の議論は交渉相手に見せない |

### 7.2 同期の仕組み（Hubble→Negoで開始した場合）

```
    Hubble（社内）                      Nego（交渉相手と共有）
      │                                  │
      │  「交渉相手に共有」(手動)        │
      │ ──────────────────────────────→ │  Nego Ver.1として表示
      │                                  │
      │                                  │  交渉相手が修正版をアップロード
      │ ←────────────────────────────── │  （自動同期）
      │  Hubbleに新バージョンとして追加  │
      │                                  │
      │  社内で修正                      │
      │  （この時点ではNegoに反映されない）│
      │                                  │
      │  「交渉相手に共有」(手動)        │
      │ ──────────────────────────────→ │  Negoに新バージョンとして表示
      │                                  │
```

### 7.3 ルール
1. **Nego → Hubble：自動同期** — 交渉相手・自社どちらのアップロードでも、Hubble側に新バージョンとして即時反映
2. **Hubble → Nego：手動共有** — Hubble側で「交渉相手に共有」ボタンを押した時のみ、Nego側に新バージョンとして反映
3. **バージョン番号は各システムで独立** — Hubble Ver.5 = Nego Ver.3 などになりうる

### 7.4 Nego→Hubble連携時のバージョン同期（後から連携するケース）

Nego単体で交渉を進めた後、Hubbleドキュメントと後から連携する場合の同期ルール。

```
【連携前】
Nego:   Ver.1 → Ver.2 → ... → Ver.8（最新）
Hubble: Ver.1 → Ver.2 → Ver.3（最新）
※ それぞれ独立して存在、同期なし

【「連携する」を押した瞬間】
Nego Ver.8（最新）の内容 → Hubble側にVer.4として自動同期

【連携後】
交渉相手がNego Ver.9をアップロード → Hubble Ver.5に自動同期
自社がHubble Ver.6をアップロード   → 「交渉相手に共有」を押すとNego Ver.10に反映
```

| 項目 | 仕様 |
|------|------|
| 連携時の初回同期 | Nego側の最新バージョンをHubble側に新バージョンとして同期 |
| 同期の起点 | 連携した時点から |
| 過去バージョン | 遡及しない（Nego Ver.1〜7はHubbleに同期されない） |
| バージョン番号 | 引き続き各システムで独立（紐付けは行わない） |
| 連携後のNego→Hubble | 自動同期（§7.3ルール1と同一） |
| 連携後のHubble→Nego | 手動共有（§7.3ルール2と同一） |

---

## 8. Hubbleドキュメント連携モーダル（Nego側）

Nego単体利用のユーザーが、既存のHubbleドキュメントと連携する場合に使用するモーダル。
negotiation.html のヘッダーにある「Hubble連携」ボタンから起動する。

### 8.1 モーダルレイアウト

2ステップ構成で、URL入力→プレビュー確認の順に進む。

```
┌─────────────────────────────────────────────────────────────────┐
│  🔗 Hubbleドキュメントを連携                              [×]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ── Step 1: URL入力 ──                                          │
│  ドキュメントURL                                                │
│  [ https://app.hubble.jp/docs/xxxxx      ] [取得]               │
│  💡 HubbleのドキュメントURLを貼り付けてください。               │
│     最新バージョンが連携されます。                               │
│                                                                  │
│  ── Step 2: プレビュー確認（取得後に表示）──                    │
│  連携するドキュメント                                           │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ 📄 株主間契約書（第3版）                                │    │
│  │    最新: Ver.5  ・  2026/01/28                          │    │
│  │    [レビュー中]                                         │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                              [キャンセル] [🔗 連携する]         │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 仕様

| 項目 | 仕様 |
|------|------|
| 起動方法 | negotiation.html ヘッダーの「Hubble連携」ボタン（Hubble未連携時のみ表示） |
| Step 1 | HubbleドキュメントURLを入力し「取得」をクリック |
| Step 2 | ドキュメント情報（タイトル、最新バージョン、日付、ステータス）をプレビュー表示 |
| 「連携する」ボタン | Step 2 のプレビュー表示後に有効化（Step 1 時点ではdisabled） |
| 連携時の動作 | Nego側の最新バージョンをHubble側に新バージョンとして自動同期（§7.3参照） |
| 連携後の表示 | ヘッダーの「Hubble連携」ボタンが「Hubbleで見る」リンクに切り替わる |

---

## 9. Nego側の表示（Hubble連携時）

招待された交渉相手から見たNego画面。基本的には通常のNego画面と同じだが、一部表示が異なる。

### 9.1 違い

| 項目 | Nego単体 | Hubble連携時 |
|------|---------|-------------|
| 契約書オーナー表示 | 「〇〇さん」 | 「〇〇さん（Hubble経由）」バッジ |
| アップロード | 両者可能 | 両者可能（Hubble側に自動同期） |

---

## 10. デモファイル対応表

| 画面 | ファイル | 説明 |
|------|---------|------|
| Hubble（初回共有前） | hubble-ui-first-share.html | 交渉開始前 |
| Hubble（交渉中） | hubble-ui.html | 交渉バナー付き |
| Nego交渉画面 | negotiation.html | 交渉相手との画面 |
| 署名画面 | sign.html | 署名専用画面 |

---

## 11. 想定ユースケース

### 11.1 典型的なシナリオ

1. **法務部門がHubbleで契約書を作成・レビュー**
   - 社内コメントで法務チーム内の議論
   - 「先方に送って大丈夫です」のコメント

2. **営業担当が「交渉相手に共有」をクリック**
   - 招待モーダルで取引先担当者のメールを入力
   - 招待送信

3. **取引先担当者がNegoで契約書を確認**
   - AI解説を見ながら内容理解
   - 修正版をアップロード

4. **Hubbleに修正版が自動反映**
   - 法務部門がHubble上で差分確認
   - 社内コメントで修正対応を議論

5. **署名手続き・契約締結**
   - Nego上で署名手続き・設定を実行（→ PRD_Common.md 参照）
   - 全署名者の署名完了で契約締結
   - Hubbleのステータスも「締結済み」に更新

---

**Document Version:** 3.0
**Last Updated:** 2026-02-10
