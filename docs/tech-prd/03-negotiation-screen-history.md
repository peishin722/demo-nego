# Tech PRD: 交渉画面 - 履歴管理 (Negotiation History)

> **【どんな画面？】**
> 交渉画面（詳細）の左サイドバーで操作する機能です。
> 「第1版」「第2版」といった過去の履歴を確認したり、修正した新しい契約書ファイルをアップロードしたりします。

## 1. 画面設計 (Visual Design Spec)

### UI構成要素
- **バージョン履歴パネル** (契約書タブの左サイドバー):
  - `[バージョンリスト]`: バージョン一覧（例: "v2.0 (最新)", "v1.0"）。
  - `[新規版アップロードボタン]`: "新しい版をアップロード"。
  - `[ダウンロードボタン]`: 特定バージョンをダウンロードするアイコン。
- **差分ビューア (Diff)**:
  - `[差分表示トグル]`: "変更箇所を表示" チェックボックス。
  - `[差分ハイライト]`: 追加テキストは緑背景、削除テキストは赤の取り消し線。
  - `[差分モーダル]`: (オプション) 変更前後を左右に並べて比較表示。

### 状態定義 (States)
- **最新版表示 (Viewing_Latest)**: デフォルト状態。編集可能（権限がある場合）。
- **過去版表示 (Viewing_Past)**: "過去のバージョンを表示しています" という読み取り専用バナーを表示。
- **差分モード (Diff_Mode)**: テキストに変更箇所のハイライトが表示されている状態。

### ユーザーフロー (Mermaid)
```mermaid
graph TD
    A[契約書を表示] --> B[履歴パネルをクリック]
    B --> C[過去のバージョンを選択]
    C --> D[過去版を表示 (読み取り専用)]
    
    A --> E['新しい版をアップロード'をクリック]
    E --> F[ファイルを選択]
    F --> G[アップロード & 処理]
    G --> H[新バージョン作成 (v+1)]
    H --> I[新バージョンを表示]
    
    A --> J['変更箇所を表示'をONにする]
    J --> K[前バージョンとの差分をハイライト]
```

## 2. 振る舞い仕様 (BDD)

```gherkin
Feature: バージョン管理

  Scenario: 新しい版のアップロード
    Given 現在 "v1.0" を表示している
    When "新しい版をアップロード" から "contract_revised.docx" をアップロードする
    Then バージョンが "v2.0" に更新される
    And 履歴リストの一番上に "v2.0 (最新)" が追加される
    And タイムスタンプとアップロード者が記録される

  Scenario: 過去のバージョンの閲覧
    Given 履歴リストに "v2.0", "v1.0" がある
    When "v1.0" をクリックする
    Then 契約書ビューアの内容が "v1.0" のものに切り替わる
    And 画面上部に "これは過去のバージョンです" という警告バーが表示される
    And 編集やコメント追加はできない

  Scenario: 差分表示（Diff）
    Given 現在 "v2.0" を表示しており、"v1.0" から変更がある
    When "変更箇所を表示" トグルをONにする
    Then 追加された箇所が緑色でハイライトされる
    And 削除された箇所が赤色の取り消し線で表示される
```

## 3. 非機能要件・受入基準
- **差分精度**: 行単位ではなく、単語/文字単位での差分が見やすく表示されること。
- **保存**: 全バージョンのファイルが保持され、いつでもダウンロード可能であること。
